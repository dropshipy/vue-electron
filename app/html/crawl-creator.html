<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Auto Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-toasted"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </head>
  <body>
    <div id="app">
      <div class="bg-white p-[20px]">
        <a href="../index.html">Home</a>
        <h1 class="text-xl font-semibold mb-6">
          Konfigurasi Kirim Pesan ke Kreator
        </h1>
        <p v-if="isLoadingGetConfig" class="bg-black">Loading</p>
        <div>
          <template v-if="subscriptionId">
            <main>
              <div
                class="md:grid md:grid-cols-1 lg:grid-cols-2 xl:gap-6 w-full mt-3"
              >
                <div class="w-full">
                  <!-- Pilihan Login -->
                  <!-- <div class="py-3 px-2 lg:px-5 h-fit">
                  <h2 class="text-lg font-bold mb-4">
                    Pilihan Login Tiktok Seller
                  </h2>
                  <div class="mb-4">
                    <div
                      v-for="(method, id) in options.loginMethods"
                      :key="id"
                      class="my-1"
                    >
                      <input
                        :id="method.name"
                        v-model="selected.loginMethod"
                        type="radio"
                        :name="method.name"
                        :value="method.value"
                        class="cursor-pointer"
                      />
                      <label
                        class="text-gray-700 font-medium ml-2 cursor-pointer"
                        :for="method.name"
                      >
                        {{ method.name }}
                      </label>
                    </div>
                  </div>
                </div> -->

                  <!-- Konfigurasi Undangan untuk Affiliator -->
                  <div class="py-3 px-2 lg:px-5 h-fit">
                    <h2 class="text-lg font-bold mb-2">
                      Konfigurasi Bot Automasi
                    </h2>
                    <div class="mb-4">
                      <label
                        class="block text-gray-700 font-medium mb-2"
                        for="whatsapp"
                        >Jumlah pengulangan automasi</label
                      >
                      <input
                        id="bot-iteration"
                        v-model="selected.iteration"
                        type="number"
                        class="block w-full border border-gray-400 rounded-md py-2 px-3"
                      />
                    </div>
                  </div>

                  <!-- Kategori Utama -->
                  <div class="py-3 px-2 lg:px-5 h-fit">
                    <h2 class="text-lg font-bold mb-4">Kategori Utama</h2>
                    <div class="mb-4">
                      <label
                        class="block text-gray-700 font-medium mb-2"
                        for="category"
                      >
                        Kategori
                      </label>
                      <div
                        class="relative cursor-pointer border border-gray-400 rounded-md py-2 px-3"
                      >
                        <div
                          class="absolute top-0 left-0 right-0 h-[40px] z-40"
                          @click="isShowCategory = !isShowCategory"
                        ></div>
                        <img
                          src="../assets/icons/chevron.svg"
                          alt="chevron"
                          class="absolute top-1/2 -translate-y-1/2 right-[10px] z-30 transition-all ease-in-out duration-200 rotate-180"
                          :class="{ 'rotate-0': isShowCategory }"
                        />
                        <input
                          :value="categoryValue"
                          type="text"
                          placeholder="Pilih kategori"
                          readonly
                          class="cursor-pointer relative block w-full focus:outline-none truncate"
                          :class="{
                          'max-w-[90px] md:max-w-[250px] lg:max-w-[140px] xl:max-w-[70%]':
                            isShowCategory,
                        }"
                        />
                        <button
                          v-if="isShowCategory && categoryValue.length > 0"
                          class="text-[#EE4D2D] text-xs font-medium absolute right-14 z-40 top-1/2 -translate-y-1/2 px-1 md:px-2 py-1 border-[1px] rounded border-[#EE4D2D]"
                          @click="deleteCategoryVal"
                        >
                          Hapus Semua
                        </button>
                        <div
                          v-if="isShowCategory"
                          class="absolute bg-white h-40 overflow-y-scroll space-y-2 w-full shadow rounded-b top-[105%] left-0"
                        >
                          <section
                            v-for="(category, id) in options.categoryOptions"
                            :key="id"
                            class="flex items-center justify-between hover:bg-primary/[10%] px-2"
                          >
                            <div class="w-full">
                              <p
                                @click="handleCategoryOption(category.name)"
                                class="hover:opacity-60"
                                :class="{
                                'text-[#EE4D2D]': categoryValue.includes(
                                  category.name
                                ),
                              }"
                              >
                                {{ category.name }}
                              </p>
                            </div>
                            <img
                              v-if="categoryValue.includes(category.name)"
                              src="../assets/icons/radio.svg"
                              alt="succsess"
                              class="mr-3"
                            />
                          </section>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Atribut Kreator -->
                  <div class="py-3 px-2 lg:px-5 h-fit">
                    <h2 class="text-lg font-bold mb-4">Atribut Kreator</h2>
                    <div class="mb-4">
                      <label class="block text-gray-700 font-medium mb-2"
                        >Media Sosial
                      </label>
                      <select
                        v-model="selected.socialMedias"
                        class="border border-gray-400 p-2 rounded-md w-full"
                      >
                        <option value="" disabled selected>
                          Pilih Sosial Media Kreator
                        </option>
                        <option
                          v-for="item in options.socialMedia"
                          :key="item.id"
                          :value="item.value"
                        >
                          {{ item.name }}
                        </option>
                      </select>
                    </div>
                  </div>
                </div>

                <div class="w-full">
                  <!-- Profil Pengikut -->
                  <div class="py-3 px-2 lg:px-5 h-fit">
                    <h2 class="text-lg font-bold mb-4">
                      Filter Jumlah Pengikut
                    </h2>
                    <div class="mb-4">
                      <label
                        class="block text-gray-700 font-medium mb-2"
                        for="jumlah-pengikut"
                      >
                        Pengikut</label
                      >
                      <select
                        id="jumlah-pengikut"
                        v-model="selected.followerCount"
                        class="border border-gray-400 p-2 rounded-md w-full"
                      >
                        <option value="" disabled selected>
                          Pilih jumlah pengikut
                        </option>
                        <option
                          v-for="item in options.followerCountOptions"
                          :key="item.id"
                          :value="item.value"
                        >
                          {{ item.name }}
                        </option>
                      </select>
                    </div>
                    <div class="mb-4">
                      <label
                        class="block text-gray-700 font-medium mb-2"
                        for="usia-pengikut"
                        >Usia
                      </label>
                      <select
                        id="usia-pengikut"
                        v-model="selected.followerAge"
                        class="border border-gray-400 p-2 rounded-md w-full"
                      >
                        <option value="" disabled selected>
                          Pilih usia pengikut
                        </option>
                        <option
                          v-for="item in options.followerAgeOptions"
                          :key="item.id"
                          :value="item.value"
                        >
                          {{ item.name }}
                        </option>
                      </select>
                    </div>
                    <div class="mb-4">
                      <label
                        class="block text-gray-700 font-medium mb-2"
                        for="gender-pengikut"
                        >Jenis Kelamin
                      </label>
                      <select
                        id="gender-pengikut"
                        v-model="selected.followerGender"
                        class="border border-gray-400 p-2 rounded-md w-full"
                      >
                        <option value="" disabled selected>
                          Pilih gender pengikut
                        </option>
                        <option
                          v-for="item in options.followerGenderOptions"
                          :key="item.id"
                          :value="item.value"
                        >
                          {{ item.name }}
                        </option>
                      </select>
                    </div>
                  </div>

                  <!-- Konfigurasi Undangan untuk Affiliator -->
                  <div class="py-3 px-2 lg:px-5 h-fit">
                    <h2 class="text-lg font-bold mb-2">
                      Pesan Undangan ke Kreator
                    </h2>
                    <div class="mb-4">
                      <label
                        class="block text-gray-700 font-medium mb-2"
                        for="pesanUndangan"
                        >Pesan undangan ke affiliator (Harus diisi)</label
                      >
                      <textarea
                        v-model="selected.replyMessage"
                        placeholder="masukkan pesan undangan"
                        name="pesanUndangan"
                        class="block w-full border border-gray-400 rounded-md py-2 px-3"
                        maxlength="300"
                      ></textarea>
                      <span
                        v-if="error.replyMessage"
                        class="text-red-500 text-sm ml-2"
                        >{{ error.replyMessage }}</span
                      >
                    </div>
                  </div>
                  <div class="w-full hidden lg:block mt-3 lg:px-4">
                    <button
                      class="bg-secondary text-white px-4 py-3 rounded-md hover:bg-secondary w-full"
                      @click="handleSubmit"
                    >
                      Simpan
                    </button>
                  </div>
                </div>
              </div>
              <div class="flex gap-2 lg:hidden mt-3 lg:px-4">
                <button
                  class="bg-black text-white px-4 py-3 rounded-md hover:opacity-80 w-full"
                  @click="handleSubmit"
                >
                  Simpan
                </button>
                <button
                  @click="processCrawlCreator"
                  :disabled="!hasConfig"
                  class="bg-black text-white px-4 py-3 rounded-md w-full hover:opacity-80"
                >
                  Proses Chat Otomatis
                </button>
              </div>
            </main>
          </template>
          <template v-else>
            <div
              class="w-full lg:w-1/2 rounded-lg p-4 flex justify-center border"
            >
              Kamu belum berlangganan Shopee Blast
            </div>
          </template>
        </div>
      </div>
    </div>
    <script>
      Vue.use(Toasted, {
        position: "top-right",
        duration: 1500,
        theme: "toasted-primary",
        iconPack: "fontawesome",
      });
      new Vue({
        el: "#app",
        data: {
          isLoadingGetConfig: false,
          cookies: null,
          isShowCategory: false,
          hasConfig: false,
          userInfo: null,
          subscriptionId: null,
          userId: null,
          options: {
            loginMethods: [
              {
                id: 1,
                name: "Dengan Qr",
                value: "qr",
              },
              {
                id: 2,
                name: "Akun Shopee Seller (No HP/Email)",
                value: "seller_phone",
              },
              {
                id: 3,
                name: "Akun Gmail",
                value: "seller_gmail",
              },
              {
                id: 4,
                name: "Akun Facebook",
                value: "seller_facebook",
              },
            ],
            categoryOptions: [
              { id: 1, name: "Semua", value: "Semua" },
              { id: 2, name: "Kesehatan", value: "Kesehatan" },
              { id: 3, name: "Aksesoris Fashion", value: "Aksesoris Fashion" },
              { id: 4, name: "Elektronik", value: "Elektronik" },
              { id: 5, name: "Pakaian Pria", value: "Pakaian Pria" },
              { id: 6, name: "Sepatu Pria", value: "Sepatu Pria" },
              {
                id: 7,
                name: "Handphone & Aksesoris",
                value: "Handphone & Aksesoris",
              },
              {
                id: 8,
                name: "Fashion Muslim",
                value: "Fashion Muslim",
              },
              {
                id: 8,
                name: "Koper & Tas Travel",
                value: "Koper & Tas Travel",
              },
              {
                id: 9,
                name: "Tas Wanita",
                value: "Tas Wanita",
              },
              {
                id: 10,
                name: "Pakaian Wanita",
                value: "Pakaian Wanita",
              },
              {
                id: 11,
                name: "Food Delivery",
                value: "Food Delivery",
              },
              {
                id: 12,
                name: "Sepatu Wanita",
                value: "Sepatu Wanita",
              },
              {
                id: 13,
                name: "Tas Pria",
                value: "Tas Pria",
              },
              {
                id: 14,
                name: "Jam Tangan",
                value: "Jam Tangan",
              },
              {
                id: 15,
                name: "Audio",
                value: "Audio",
              },
              {
                id: 16,
                name: "Makanan & Minuman",
                value: "Makanan & Minuman",
              },
              {
                id: 17,
                name: "Perawatan & Kecantikan",
                value: "Perawatan & Kecantikan",
              },
              {
                id: 18,
                name: "Hewan Peliharaan",
                value: "Hewan Peliharaan",
              },
              {
                id: 19,
                name: "Ibu & Bayi",
                value: "Ibu & Bayi",
              },
              {
                id: 20,
                name: "Fashion Bayi & Anak",
                value: "Fashion Bayi & Anak",
              },
              {
                id: 21,
                name: "Gaming & Konsol",
                value: "Gaming & Konsol",
              },
              {
                id: 22,
                name: "Kamera & Drone",
                value: "Kamera & Drone",
              },
              {
                id: 23,
                name: "Perlengkapan Rumah",
                value: "Perlengkapan Rumah",
              },
              {
                id: 24,
                name: "Olahraga & Outdoor",
                value: "Olahraga & Outdoor",
              },
              {
                id: 25,
                name: "Buku & Alat Tulis",
                value: "Buku & Alat Tulis",
              },
              {
                id: 26,
                name: "Hobi & Koleksi",
                value: "Hobi & Koleksi",
              },
              {
                id: 27,
                name: "Mobil",
                value: "Mobil",
              },
              {
                id: 28,
                name: "Sepeda Motor",
                value: "Sepeda Motor",
              },
              {
                id: 29,
                name: "Tiket, Voucher, & Layanan",
                value: "Tiket, Voucher, & Layanan",
              },
              {
                id: 30,
                name: "Buku & Majalah",
                value: "Buku & Majalah",
              },
              {
                id: 31,
                name: "Komputer & Aksesoris",
                value: "Komputer & Aksesoris",
              },
              {
                id: 32,
                name: "Deals Sekitarmu",
                value: "Deals Sekitarmu",
              },
            ],
            socialMedia: [
              { id: 1, name: "Semua", value: "Semua" },
              { id: 2, name: "Shopee", value: "Shopee" },
              { id: 3, name: "Instagram", value: "Instagram" },
              { id: 4, name: "Tiktok", value: "Tiktok" },
              { id: 5, name: "Facebook", value: "Facebook" },
              { id: 6, name: "Twitter", value: "Twitter" },
              { id: 7, name: "Youtube", value: "Youtube" },
            ],

            followerCountOptions: [
              { id: 1, name: "Semua", value: "Semua" },
              { id: 2, name: "≥ 1RB", value: "1RB" },
              { id: 3, name: "≥ 5RB", value: "5RB" },
              { id: 4, name: "≥ 10RB", value: "10RB" },
              { id: 5, name: "≥ 50RB", value: "50RB" },
              { id: 6, name: "≥ 100RB", value: "100RB" },
              { id: 7, name: "≥ 500RB", value: "500RB" },
              { id: 8, name: "≥ 5JT", value: "5JT" },
            ],
            followerAgeOptions: [
              { id: 1, name: "Semua", value: "Semua" },
              { id: 2, name: "13-", value: "13-" },
              { id: 3, name: "13-17", value: "13-17" },
              { id: 4, name: "18-22", value: "18-22" },
              { id: 5, name: "23-32", value: "23-32" },
              { id: 6, name: "33-42", value: "33-42" },
              { id: 7, name: "43-52", value: "43-52" },
              { id: 8, name: "53+", value: "53+" },
            ],
            followerGenderOptions: [
              { id: 1, name: "Semua", value: "Semua" },
              { id: 2, name: "Perempuan", value: "Perempuan" },
              { id: 3, name: "Laki-laki", value: "Laki-laki" },
            ],
          },
          categoryValue: [],
          selected: {
            iteration: 1,
            socialMedias: "",
            followerCount: "",
            followerAge: "",
            followerGender: "",
            invitationMessage: "",
            loginMethod: "qr",
            replyMessage: "",
          },
          errorMessage: false,
          error: {
            replyMessage: "",
          },
          // userConfig: null,
        },
        mounted() {
          const getUserInfo = localStorage.getItem("user_info");
          this.userInfo = JSON.parse(getUserInfo);
          this.userId = this.userInfo.id;
          this.subscriptionId = this.userInfo.subscriptionId;
          this.sendGetConfig();
        },
        methods: {
          processCrawlCreator() {
            window.electron.ipcRenderer.send("crawl-creator", this.selected);
          },

          handleCategoryOption(val) {
            console.log(val);
            if (val === "Semua") {
              this.categoryValue = ["Semua"];
            } else {
              if (!this.categoryValue.includes(val)) {
                this.categoryValue.push(val);
                const finalArr = this.categoryValue.filter(
                  (fil) => fil !== "Semua"
                );
                this.categoryValue = finalArr;
              } else {
                const filterArr = this.categoryValue.filter(
                  (fil) => fil !== val
                );
                const finalArr = filterArr.filter((fil) => fil !== "Semua");
                this.categoryValue = finalArr;
              }
            }
          },
          async sendGetConfig() {
            try {
              this.isLoadingGetConfig = true;
              console.log(this.isLoadingGetConfig);
              window.electron.ipcRenderer.send(
                "get-crawl-creator-config",
                this.subscriptionId
              );
              await this.getConfigFromStore();

              // setTimeout(async () => {
              //   await this.getConfigFromStore();
              // }, 1000);
            } catch (error) {
              console.log(error);
            } finally {
              // this.isLoadingGetConfig = false;
              console.log(this.isLoadingGetConfig);
            }
          },
          // getConfigFromStore() {
          //   return new Promise((resolve, reject) => {});
          //   const xhr = new XMLHttpRequest();
          //   xhr.onreadystatechange = () => {
          //     if (xhr.readyState === 4 && xhr.status === 200) {
          //       const data = JSON.parse(xhr.responseText);
          //       if (data) {
          //         this.selected = data;
          //         this.hasConfig = true;
          //         this.categoryValue = data.category;
          //       }
          //       console.log(data.email);
          //       this.email = data.email;
          //       this.password = data.password;
          //       this.subscription = data.subscription;
          //     }
          //   };

          //   xhr.open("GET", "../store/user-crawl-creator-config.json", true);
          //   xhr.send();
          // },
          async getConfigFromStore() {
            try {
              const response = await fetch(
                "../store/user-crawl-creator-config.json"
              );
              if (!response.ok) {
                new Error(`Failed to fetch data. Status: ${response.status}`);
                this.isLoadingGetConfig = false;
              } else {
                const res = await response.text();
                if (res) {
                  const data = JSON.parse(res);
                  this.selected = data;
                  this.hasConfig = true;
                  this.categoryValue = data.category;
                }
                this.isLoadingGetConfig = false;
              }
            } catch (error) {
              console.error(error);
            }
          },
          async handleSubmit() {
            const { selected, userId, subscriptionId } = this;
            const category = this.categoryValue;
            const payload = { ...selected, category, userId, subscriptionId };
            if (!this.selected.replyMessage) {
              this.error.replyMessage = "Balasan Ulasan tidak boleh kosong";
            } else {
              try {
                if (this.hasConfig) {
                  window.electron.ipcRenderer.send(
                    "update-crawl-creator-config",
                    payload
                  );
                  this.$toasted.success("Berhasil menyimpan konfigurasi ", {
                    icon: "check-circle",
                  });
                  await this.sendGetConfig();

                  // setTimeout(async () => {
                  //   await this.sendGetConfig();
                  // }, 3000);
                } else {
                  window.electron.ipcRenderer.send(
                    "post-crawl-creator-config",
                    payload
                  );
                  this.$toasted.success("Berhasil menyimpan konfigurasi ", {
                    icon: "check-circle",
                  });
                  this.hasConfig = true;
                  await this.sendGetConfig();

                  // setTimeout(async () => {
                  //   await this.sendGetConfig();
                  // }, 3000);
                }
                this.$toast.success("Berhasil menyimpan konfigurasi");
              } catch (error) {
                console.log(error);
              }
            }
          },
          deleteCategoryVal() {
            this.categoryValue = [];
          },
        },
      });
    </script>
  </body>
</html>
